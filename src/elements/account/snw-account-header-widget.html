<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="snw-login.html">
<link rel="import" href="snw-logout.html">
<link rel="import" href="snw-account-drop.html">
<link rel="import" href="../helpers/snw-ls.html">
<link rel="import" href="../helpers/snw-jwt-helper.html">
<link rel="import" href="../../styles/dark-theme/dark-theme.html">

<dom-module id="snw-account-header-widget">
  <template>
    <style include="dark-theme"></style>
    <snw-jwt-helper id="jwtHelper"></snw-jwt-helper>
    <snw-ls id="ls" on-ls-change="handleLsChange"></snw-ls>

    <paper-button hidden="{{!_isLoggedIn}}" on-tap="toggleDrop">{{_account.userName}}</paper-button>
    <snw-account-drop id="drop" on-do-logout="doLogout"></snw-account-drop>
    <snw-logout id="logout" on-logout="handleLogout">
      <paper-button class="hideIfSmall" hidden="{{!_isLoggedIn}}">Logout</paper-button>
    </snw-logout>
    <snw-login on-login="handleLogin">
      <paper-button data-dialog="login" hidden="{{_isLoggedIn}}">Login</paper-button>
      <paper-button data-dialog="register" hidden="{{_isLoggedIn}}" class="hideIfSmall">Register</paper-button>
    </snw-login>
  </template>

  <script>
    (function(){
      'use strict';
      Polymer({
        is: 'snw-account-header-widget',
        properties:{
          _account: {
            type: Object,
            notify: true,
            value: {}
          },

          _isLoggedIn: {
            type: Boolean,
            notify: true,
            value: false
          }
        },

        ready: function(){
          this.set('_account', this.$.ls.getLs('account'));
        },

        handleLsChange: function(e){
          if(e.detail.type === 'jwt'){
            this._isLoggedIn = (e.detail.e.length > 0);
          }
        },

        handleLogin: function(){
          this.set('_account', this.$.ls.getLs('account'));
          this._isLoggedIn = true;
        },
        
        handleLogout: function(){
          this._isLoggedIn = false;
        },
        
        toggleDrop: function(e){
          this.$.drop.toggle();
        },

        doLogout: function(){
          this.$.logout.logout();
        }
      });
    })();
  </script>
</dom-module>