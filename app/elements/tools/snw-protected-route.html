<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="snw-protected-route">
  <template>
    <snw-account-ls id="sals" jwt="{{jwt}}"></snw-account-ls>
    <iron-signals on-iron-signal-login="iron" on-iron-signal-logout="iron"></iron-signals>
    <carbon-route-converter path="{{nPath}}" route="{{route}}"></carbon-route-converter>
    <carbon-route route="{{route}}" pattern="/:page" data="{{pageData}}" tail="{{pageTail}}"></carbon-route>
    <carbon-route route="{{pageTail}}" pattern="/:id" data="{{tailData}}" tail="{{mTail}}"></carbon-route>
    <carbon-route route="{{mTail}}" pattern="/:m" data="{{mData}}"></carbon-route>

    <snw-toast id="stoast"></snw-toast>
  </template>

  <script>
    (function () {
      'use strict';
      Polymer({
        is: 'snw-protected-route',

        properties:{
          scopes:{
            type: Array,
            notify: true
          },
          redirect:{
            type: Boolean
          },
          data:{
            type: Object,
            notify: true,
            observer: 'routeDataChanged'
          },
          path:{
            type: String,
            notify: true
          },

          jwt: Object,
          nPath: String,
          pageData: Object,
          tailData: Object,
          mData: Object
        },

        ready: function () {
          this.scopes = this.scopes || [];
          //Build the path we are going to be comparing the current path
          this.bPath = this.buildPath(this.path);
        },

        iron: function () {
          this.checkAccess();
        },

        doRedirect: function () {
          window.location = '/#/home';
        },

        routeDataChanged: function () {
          this.checkAccess();
          console.log(this.route);
          console.log(this.data);
        },

        checkAccess: function () {
          if(!this.checkPath(this.data, this.bPath)){
            return;
          }

          this.$.sals.reload();
          if(this.checkScopes(this.scopes, this.jwt)){
            return;
          }

          this.$.stoast.show('No permissions to access ' + window.location, true);
          if(this.redirect){
            var l = this;
            setTimeout(function () {
              l.doRedirect();
            }, 100);
          }
        },

        checkJwt: function (jwt) {
          return this.$.sals.validateJwt(jwt);
        },

        decodeJwt: function (jwt) {
          return this.$.sals.parseJwt(jwt);
        },

        //Only require one scope to be true
        checkScopes: function (scopes, jwt) {
          if(this.checkJwt(jwt)){
            var decoded = this.decodeJwt(jwt);

            for(var i = 0; i < scopes.length; i++){
              for(var d = 0; i < decoded.scopes.length; d++){
                if(decoded.scopes[d].field == scopes[i]){
                  return true;
                }
              }

              for(var x = 0; x < decoded.groups.length; x++){
                for(var c = 0; c < decoded.groups[x].scopes.length; c++){
                  if(decoded.groups[x].scopes[c].field == scopes[i]){
                    return true;
                  }
                }
              }

            }
          }else{
            return false;
          }
        },

        buildPath: function (path) {
          this.nPath = path;
//          console.log(this.route);

          var d = {};
          d.page = this.pageData.page || null;

          if(this.tailData){
            d.id = this.tailData.id;
          }else{
            d.id = null;
          }

          if(this.mData){
            d.modifier = this.mData.m;
          }else{
            d.modifier = null;
          }
          return d;
        },
        
        checkPath: function (data, bPath) {
          if(!bPath || !data){
            return false;
          }

          if(bPath.page == data.page || bPath.page == '*'){
            if(bPath.id == data.id || bPath.id == '*'){
              if(bPath.modifier == data.modifier || bPath.modifier == '*'){
                return true;
              }
            }
          }
          return false;
        }
      });
    })();
  </script>
</dom-module>
